<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Head and Neck DMG Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { background: #e6f2fa; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
    .container { background: #fff; margin: 40px auto; border-radius: 20px; box-shadow: 0 6px 32px rgba(38, 110, 168, 0.1); max-width: 1400px; padding: 30px 30px 60px 30px;}
    h1 { text-align: center; letter-spacing: 2px; color: #2878bb; margin-top: 0; font-size: 2.2em; }
    .filters, .form-row { display: flex; gap: 14px; margin-bottom: 18px; flex-wrap: wrap; }
    label { font-weight: 500; font-size: 0.98em; color: #2878bb; margin-right: 3px; }
    input, select, textarea { border: 1px solid #c5e0f7; border-radius: 7px; padding: 7px 10px; background: #f6fbff; outline: none; font-size: 1em; }
    input[type="date"] { font-size: 0.97em; }
    .btn, button, input[type="button"] { background: #2878bb; color: #fff; padding: 7px 18px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.18s; margin-left: 6px;}
    .btn:hover, button:hover, input[type="button"]:hover { background: #1462a1; }
    .stats { margin: 15px 0 7px 0; font-size: 1.05em; color: #2878bb; font-weight: 500; display: flex; gap: 24px; flex-wrap: wrap; }
    .alert { color: #fff; background: #e74c3c; padding: 4px 12px; border-radius: 6px; margin-bottom: 8px; display: inline-block; font-size: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #f6fbff; border-radius: 14px; overflow: hidden; font-size: 0.98em; }
    th, td { padding: 9px 6px; border-bottom: 1px solid #c9e8fc; text-align: center; }
    th { background: #d8eefd; color: #2878bb; font-size: 1.05em; letter-spacing: 1px; }
    tr:last-child td { border-bottom: none; }
    .actions-btn { display: flex; gap: 6px; justify-content: center; }
    .edit-btn { background: #ffa726; color: #fff; }
    .delete-btn { background: #e74c3c; color: #fff; }
    .whatsapp-link img { height: 21px; vertical-align: middle; }
    .pie-container { max-width: 280px; margin: 30px auto 0 auto; padding: 16px; background: #f6fbff; border-radius: 18px; box-shadow: 0 4px 14px rgba(38,110,168,0.09); text-align: center;}
    #pieChart { max-width: 240px; max-height: 200px;}
    .bar-container { max-width: 600px; margin: 30px auto 0 auto; padding: 16px; background: #f6fbff; border-radius: 18px; box-shadow: 0 4px 14px rgba(38,110,168,0.09);}
    #barChart { max-width: 540px; max-height: 270px;}
    .footer-credit { text-align: center; color: #555; margin: 30px auto 12px auto; font-size: 1.02em; letter-spacing: 1px; opacity: 0.82;}
    .logout-btn { position: fixed; top: 12px; right: 28px; background: #ec4899; color: #fff; border-radius: 18px; border: none; padding: 7px 23px; font-weight: 700; font-size: 1.12em; z-index: 100; box-shadow: 0 1px 10px #dbeafe; }
    .logout-btn:hover { background: #be185d;}
    .hidden { display: none !important; }
    .password-row { display: flex; gap: 8px; align-items: center;}
    .password-row input { width: 130px; }
    .user-table, .audit-table, .usage-audit-table { width: 100%; margin-top: 12px; border-collapse: collapse; font-size: 0.98em; }
    .user-table th, .audit-table th, .usage-audit-table th { background: #e3e9f7; color: #1d4e89; font-size: 1em;}
    .user-table td, .audit-table td, .usage-audit-table td { padding: 6px 5px; border-bottom: 1px solid #c9e8fc;}
    .user-table td .delete-user-btn { background: #f87171; color: #fff; border-radius: 7px; border: none; font-size: 0.95em; padding: 4px 14px;}
    .user-table td .delete-user-btn:hover { background: #991b1b;}
    /* Center login overlay */
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: #e6f2fa; display: flex; align-items: center; justify-content: center; z-index: 2000;
    }
    #loginBox {
      background: #fff; box-shadow: 0 8px 44px rgba(38,110,168,0.12); border-radius: 20px;
      padding: 36px 44px 32px 44px; min-width: 380px; max-width: 98vw;
      text-align: center; margin: 0;
    }
    #loginBox h2 {
      color: #111827; font-size: 2em; margin-bottom: 20px; font-weight: bold;
    }
    #loginBox label { text-align: left; font-weight: bold; color: #2878bb; font-size: 1.2em; }
    #loginBox input[type="text"], #loginBox input[type="password"] {
      width: 100%; font-size: 1.25em; margin-bottom: 8px; margin-top: 2px;
      box-sizing: border-box;
    }
    #loginBox .btn {
      font-size: 1.2em; padding: 7px 36px; margin-top: 18px;
    }
    #loginError { color: #e74c3c; margin-top: 10px; min-height: 20px; font-size: 1.13em; }
    /* Pagination for audit tables */
    .audit-pagination, .usage-pagination {
      text-align: center; margin: 8px 0 0 0; font-size: 1.03em;
    }
    .audit-pagination button, .usage-pagination button {
      background: #2878bb; color: #fff; border-radius: 8px; border: none; margin: 0 4px;
      font-size: 1em; font-weight: bold; padding: 2px 13px; cursor: pointer;
    }
    .audit-pagination button[disabled], .usage-pagination button[disabled] {
      background: #cbd5e1; color: #a1a1aa; cursor: default;
    }
    .selected-row { outline: 2px solid #2878bb !important; background: #eef6fb !important; }
  </style>
</head>
<body>
<button class="logout-btn hidden" id="logoutBtn" onclick="logout()">Logout</button>
<div id="loginOverlay">
  <form id="loginBox" onsubmit="return false;">
    <h2>Head and Neck DMG Dashboard</h2>
    <label for="loginUserInput">Username:</label><br>
    <input type="text" id="loginUserInput" autocomplete="username" required>
    <br>
    <label for="pwdInput">Password:</label><br>
    <input type="password" id="pwdInput" autocomplete="current-password" required>
    <br>
    <button class="btn" onclick="checkLogin()">Login</button>
    <div id="loginError"></div>
  </form>
</div>
<div class="container" style="display:none" id="mainContent">
  <h1>Head and Neck DMG</h1>

  <!-- ADMIN PANEL (now at top) -->
  <div id="adminPanel" class="admin-panel hidden">
    <h2>Admin Panel</h2>
    <div style="margin-bottom: 20px;">
      <b>Password Generator:</b><br>
      <form id="passwordGenForm" class="password-row" onsubmit="return false;">
        <input id="genNameInput" type="text" placeholder="Guest Full Name" required autocomplete="off">
        <input id="genUsername" type="text" placeholder="Username" readonly>
        <input id="genPassword" type="text" placeholder="Password" readonly>
        <button class="btn" onclick="generatePassword()">Generate</button>
        <button class="btn" onclick="addUser()" type="button" id="addUserBtn" disabled>Add User</button>
      </form>
      <div id="addUserStatus" style="margin-left:10px;color:#2878bb;min-height:16px;font-size:0.99em;"></div>
    </div>
    <div style="margin-bottom: 20px;">
      <b>Current Users:</b>
      <table class="user-table" id="userTable">
        <thead>
          <tr>
            <th>Username</th><th>Full Name</th><th>Role</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="userTableStatus" style="color:#e74c3c;min-height:16px;"></div>
    </div>
    <div style="margin-bottom: 20px;">
      <b>Login/Logout Audit:</b>
      <table class="audit-table" id="auditTable">
        <thead>
          <tr>
            <th>Username</th><th>Action</th><th>Timestamp</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="audit-pagination" id="auditPagination"></div>
    </div>
    <div style="margin-bottom: 8px;">
      <b>Usage Audit (Add/Edit/Delete):</b>
      <table class="usage-audit-table" id="usageAuditTable">
        <thead>
          <tr>
            <th>Username</th><th>Action</th><th>Patient ID</th><th>Timestamp</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="usage-pagination" id="usagePagination"></div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <select id="filterCompliance">
      <option value="">All Compliance</option>
      <option value="C">Compliant</option>
      <option value="NC">Non-Compliant</option>
    </select>
    <select id="filterConsultant">
      <option value="">All Consultants</option>
      <option>Dr A.K. Das</option>
      <option>Dr R.J. Das</option>
      <option>Dr T Rahman</option>
      <option>Dr. K.Das</option>
      <option>Dr A. Das</option>
      <option>Dr. K. Kakati</option>
    </select>
    <input type="text" id="searchPID" placeholder="Patient ID">
    <button class="btn" id="addNewBtn" type="button">Add New Entry</button>
    <button class="btn" id="downloadExcelBtn" type="button" onclick="downloadExcel()">Export to Excel</button>
  </div>

  <!-- ENTRY FORM -->
  <form id="entryForm" autocomplete="off" onsubmit="return false;">
    <div class="form-row">
      <div><label>Patient ID</label><br><input id="patient_id" required></div>
      <div><label>Phone Number</label><br><input id="phone_number" type="text"></div>
      <div><label>Consultant</label><br><select id="consultant">
        <option value="">Select</option>
        <option>Dr A.K. Das</option><option>Dr R.J. Das</option><option>Dr T Rahman</option>
        <option>Dr. K.Das</option><option>Dr A. Das</option><option>Dr. K. Kakati</option>
      </select></div>
      <div><label>Primary Tumour Site</label><br><select id="primary_tumour_site">
       <option value="">Select</option><option>Oral Cavity</option><option>Oropharynx</option><option>Nasopharynx</option>
       <option>Larynx</option><option>Laryngopharynx</option><option>Thyroid</option>
       <option>Salivary glands</option><option>Sinonasal</option><option>Cutaneous Malignancy</option><option>MUO</option><option>Temporal Bone</option>
      </select></div>
      <div><label>T</label><br><select id="t_stage"><option value="">Select</option><option>Tx</option><option>Tis</option><option>T0</option><option>T1</option><option>T2</option><option>T3</option><option>T4a</option><option>T4b</option></select></div>
      <div><label>N</label><br><select id="n_stage"><option value="">Select</option><option>Nx</option><option>N0</option><option>N1</option><option>N2a</option><option>N2b</option><option>N2c</option><option>N3a</option><option>N3b</option></select></div>
      <div><label>M</label><br><select id="m_stage"><option value="">Select</option><option>M0</option><option>M1</option></select></div>
      <div><label>Date of Registration</label><br><input id="date_of_registration" type="date"></div>
      <div><label>DMG</label><br><select id="dmg">
        <option value="">Select</option>
        <option>Def RT</option><option>Def RT+CT</option><option>Pall RT</option>
        <option>Surgery</option><option>Noadjuvant CT</option><option>Pall CT</option><option>Observation</option><option>Adjuvant RT</option><option>Adjuvant RTCT</option>
      </select></div>
      <div><label>DMG Date</label><br><input id="dmg_date" type="date"></div>
      <div><label>Actual Treatment</label><br><select id="actual_treatment">
        <option value="">Select</option>
        <option>Def RT</option><option>Def RT+CT</option><option>Pall RT</option><option>Adjuvant RT</option><option>Adjuvant RTCT</option>
        <option>Surgery</option><option>Noadjuvant CT</option><option>Pall CT</option><option>Observation</option>
      <option>Referred Outside</option></select></div>
      <div><label>Actual Start Date</label><br><input id="actual_treatment_start_date" type="date"></div>
      <div><label>Date of Surgery</label><br><input id="date_of_surgery" type="date"></div>
      <div><label>Date of Starting Adjuvant RT</label><br><input id="date_of_starting_adjuvant_rt" type="date"></div>
      <div><label>Compliance Status</label><br>
        <input id="compliance_status" readonly style="background:#f2f2f2;"></div>
      <div>
        <label>Reason for Deviation</label><br>
        <select id="reason_for_deviation_select" disabled onchange="syncDeviationReason()" style="width:220px;">
          <option value="">Select Reason</option>
          <option value="Financial">Financial</option>
          <option value="Fear of treatment">Fear of treatment</option>
          <option value="Distance">Distance</option>
          <option value="Not Satisfied">Not Satisfied</option>
          <option value="Ayurvedic/Homeopathy">Ayurvedic/Homeopathy</option>
          <option value="Others">Others</option>
        </select>
        <br>
        <input type="text" id="reason_for_deviation_text" disabled placeholder="Type custom reason or add details" maxlength="120" style="width:220px;margin-top:6px;">
      </div>
      <div><label>Date of Completion of Treatment</label><br><input id="date_of_completion_of_treatment" type="date"></div>
      <div><label>TNM</label><br><input id="tnm" readonly style="background:#f2f2f2;"></div>
      <div><label>TAT (days)</label><br><input id="tat" readonly style="background:#f2f2f2;"></div>
      <div style="align-self: flex-end;">
        <input type="submit" value="Add" class="btn" id="submitBtn">
      </div>
    </div>
    <div id="formAlert" class="alert" style="display:none;"></div>
    <div id="complianceDetail" class="compliance-detail" style="display:none;"></div>
  </form>

  <!-- DATA TABLE -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Patient ID</th>
          <th>Phone</th>
          <th>Consultant</th>
          <th>Primary Site</th>
          <th>T</th><th>N</th><th>M</th><th>TNM</th>
          <th>Reg Date</th>
          <th>DMG</th>
          <th>DMG Date</th>
          <th>Actual</th>
          <th>Actual Start</th>
          <th>Surgery</th>
          <th>Adj. RT</th>
          <th>TAT</th>
          <th>Comp</th>
          <th>NC Type</th>
          <th>Reason for Deviation</th>
          <th>Complete Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div id="pagination" class="pagination"></div>
  </div>

  <!-- ANALYTICS -->
  <div class="stats" id="statsDiv"></div>
  <div class="pie-container"><canvas id="pieChart" width="240" height="200"></canvas></div>
  <div class="bar-container"><canvas id="barChart" width="540" height="270"></canvas></div>
  <div class="footer-credit">
    Created by Dr Anupam Das with the help of ChatGPT
  </div>
</div>
<script>
const API_BASE = "https://sheetdb.io/api/v1/o8uj0gn1iu70b";
const USERS_API = `${API_BASE}?sheet=Users`;
const AUDIT_API = `${API_BASE}?sheet=AuditLog`;
const USAGE_API = `${API_BASE}?sheet=UsageAudit`;
const PATIENT_API = `${API_BASE}?sheet=Sheet1`;

let userRole = null;
let username = null;
let fullName = null;
let usersData = [];
let auditData = [];
let usageAuditData = [];
let tableData = [];
let editMode = false;
let editRowId = null;
let currentPage = 1;
const rowsPerPage = 10;
let auditPage = 1, usagePage = 1;
const auditRowsPerPage = 10, usageRowsPerPage = 10;
let lastSelectedRow = null;

// ========== Utility functions ==========
function todayStr() {
  const dt = new Date();
  return dt.getFullYear() + '-' +
    String(dt.getMonth() + 1).padStart(2, '0') + '-' +
    String(dt.getDate()).padStart(2, '0');
}
function nowDateTimeStr() {
  const dt = new Date();
  return dt.getFullYear() + '-' +
    String(dt.getMonth() + 1).padStart(2, '0') + '-' +
    String(dt.getDate()).padStart(2, '0') + ' ' +
    String(dt.getHours()).padStart(2, '0') + ':' +
    String(dt.getMinutes()).padStart(2, '0') + ':' +
    String(dt.getSeconds()).padStart(2, '0');
}
function dateDiff(start, end) {
  if (!start || !end) return NaN;
  let s = new Date(start), e = new Date(end);
  if (isNaN(s.getTime()) || isNaN(e.getTime())) return NaN;
  return Math.round((e - s) / (1000 * 3600 * 24));
}
function median(arr) {
  arr = arr.filter(x => !isNaN(x)).sort((a, b) => a - b);
  if (!arr.length) return 0;
  let mid = Math.floor(arr.length / 2);
  return arr.length % 2 ? arr[mid] : ((arr[mid - 1] + arr[mid]) / 2).toFixed(1);
}
function fetchJson(url, opt) { return fetch(url, opt).then(r => r.json()); }

// ========== Compliance and NC logic ==========
function calcComplianceNCType(row) {
  const today = todayStr();
  let modalityNC = false, delayNC = false;
  if (row.dmg && row.actual_treatment && row.dmg !== row.actual_treatment) modalityNC = true;
  if ((row.dmg === "Def RT" || row.dmg === "Def RT+CT") && row.dmg_date) {
    if (!row.actual_treatment_start_date && dateDiff(row.dmg_date, today) > 15) delayNC = true;
    if (row.actual_treatment_start_date && dateDiff(row.dmg_date, row.actual_treatment_start_date) > 15) delayNC = true;
  }
  if (row.dmg === "Surgery" && row.dmg_date) {
    if (!row.date_of_surgery && dateDiff(row.dmg_date, today) > 21) delayNC = true;
    if (row.date_of_surgery && dateDiff(row.dmg_date, row.date_of_surgery) > 21) delayNC = true;
  }
  if (row.date_of_surgery && !row.date_of_starting_adjuvant_rt && dateDiff(row.date_of_surgery, today) > 42) delayNC = true;
  if (row.date_of_surgery && row.date_of_starting_adjuvant_rt && dateDiff(row.date_of_surgery, row.date_of_starting_adjuvant_rt) > 42) delayNC = true;
  if (row.actual_treatment && !row.dmg) modalityNC = true;
  let compliance = "", ncType = "";
  if (modalityNC && delayNC) { compliance = "NC"; ncType = "Modality + Delay NC"; }
  else if (modalityNC) { compliance = "NC"; ncType = "Modality NC"; }
  else if (delayNC) { compliance = "NC"; ncType = "Delay NC"; }
  else if (row.dmg && row.actual_treatment) compliance = "C";
  let detail = "";
  if (modalityNC && delayNC) detail = "Both modality and timing non-compliance";
  else if (modalityNC) detail = "Planned and actual treatment mismatch";
  else if (delayNC) detail = "Treatment delayed beyond allowed window";
  return {compliance, ncType, detail};
}

// ========== Login and session ==========
function checkLogin() {
  const user = document.getElementById("loginUserInput").value.trim().toLowerCase();
  const pwd = document.getElementById("pwdInput").value;
  document.getElementById("loginError").innerText = "Checking credentials...";
  fetchJson(`${API_BASE}/search?sheet=Users&username=${encodeURIComponent(user)}`).then(users => {
    if (users && users.length > 0 && users[0].password === pwd) {
      username = users[0].username;
      userRole = users[0].role;
      fullName = users[0].full_name || "";
      sessionStorage.setItem("dmg_user", JSON.stringify({username, userRole, fullName}));
      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      document.getElementById("logoutBtn").classList.remove("hidden");
      postAuditLog("login");
      setRolePermissions();
      fetchData();
  applyDateRestrictions();
    } else {
      document.getElementById("loginError").innerText = "Invalid username or password!";
    }
  }).catch(e => {
    document.getElementById("loginError").innerText = "Login failed, try again.";
  });
}
function logout() {
  postAuditLog("logout");
  sessionStorage.removeItem("dmg_user");
  location.reload();
}

function applyDateRestrictions() {
  const today = new Date().toISOString().split('T')[0];
  const dateFields = [
    'date_of_registration',
    'dmg_date',
    'actual_treatment_start_date',
    'date_of_surgery',
    'date_of_starting_adjuvant_rt',
    'date_of_completion_of_treatment'
  ];
  dateFields.forEach(id => {
    const elem = document.getElementById(id);
    if (elem) {
      elem.max = today;
    }
  });
}

window.onload = function() {
  const today = todayStr();
  const sess = sessionStorage.getItem("dmg_user");
  if (sess) {
    const u = JSON.parse(sess);
    username = u.username;
    userRole = u.userRole;
    fullName = u.fullName;
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    document.getElementById("logoutBtn").classList.remove("hidden");
    setRolePermissions();
    fetchData();
  applyDateRestrictions();
  }
};
document.getElementById("pwdInput").addEventListener("keyup", function(e){
  if (e.key === "Enter") checkLogin();
});
document.getElementById("loginUserInput").addEventListener("keyup", function(e){
  if (e.key === "Enter") checkLogin();
});

function setRolePermissions() {
  document.getElementById('adminPanel').classList.toggle('hidden', userRole !== "admin");
  document.getElementById('downloadExcelBtn').style.display = (userRole === "admin") ? "" : "none";
}
function loadUsers() {
  fetchJson(USERS_API).then(users => {
    usersData = users;
    renderUserTable();
  });
}
function renderUserTable() {
  let tbody = document.querySelector("#userTable tbody");
  tbody.innerHTML = "";
  usersData.forEach(u => {
    tbody.innerHTML += `
      <tr>
        <td>${u.username}</td>
        <td>${u.full_name || ""}</td>
        <td>${u.role}</td>
        <td>${u.role === "admin" ? "-" : `<button class="delete-user-btn" onclick="deleteUser('${u.username}')">Delete</button>`}</td>
      </tr>`;
  });
}
function deleteUser(user) {
  if (!confirm("Delete this user?")) return;
  fetch(`${API_BASE}?sheet=Users&username=${encodeURIComponent(user)}`, { method: "DELETE" })
    .then(() => {
      loadUsers();
      document.getElementById("addUserStatus").innerText = "User deleted!";
      setTimeout(() => document.getElementById("addUserStatus").innerText = "", 2000);
    });
}
function generatePassword() {
  let name = document.getElementById("genNameInput").value.trim().toLowerCase().replace(/\s+/g,"");
  if (name.length < 5) { document.getElementById("addUserStatus").innerText = "Name must be at least 5 letters."; return; }
  let uname = name.slice(0,5);
  let num = Math.floor(Math.random()*90000+10000).toString();
  document.getElementById("genUsername").value = uname;
  document.getElementById("genPassword").value = uname + num;
  document.getElementById("addUserBtn").disabled = false;
  document.getElementById("addUserStatus").innerText = "";
}
function addUser() {
  let uname = document.getElementById("genUsername").value;
  let pwd = document.getElementById("genPassword").value;
  let name = document.getElementById("genNameInput").value.trim();
  if (!uname || !pwd || !name) return;
  if (usersData.some(u=>u.username===uname)) {
    document.getElementById("addUserStatus").innerText = "Username already exists!";
    return;
  }
  let userRow = { username: uname, password: pwd, role: "guest", full_name: name };
  fetch(USERS_API, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ data: [userRow] })
  }).then(() => {
    loadUsers();
    document.getElementById("addUserStatus").innerText = `User added! Username: ${uname}, Password: ${pwd}`;
    document.getElementById("genUsername").value = "";
    document.getElementById("genPassword").value = "";
    document.getElementById("genNameInput").value = "";
    document.getElementById("addUserBtn").disabled = true;
    setTimeout(() => document.getElementById("addUserStatus").innerText = "", 3500);
  });
}
document.getElementById("passwordGenForm").onsubmit = e => e.preventDefault();

function postAuditLog(action) {
  fetch(AUDIT_API, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ data: [{ username, action, timestamp: nowDateTimeStr() }] })
  });
}
function postUsageAudit(action, patient_id) {
  fetch(USAGE_API, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ data: [{ username, action, patient_id, timestamp: nowDateTimeStr() }] })
  });
}
function renderAuditLog() {
  const logs = auditData || [];
  const totalPages = Math.max(1, Math.ceil(logs.length / auditRowsPerPage));
  if (auditPage > totalPages) auditPage = totalPages;
  const start = (auditPage - 1) * auditRowsPerPage;
  const end = start + auditRowsPerPage;
  const pageLogs = logs.slice(start, end);
  let tbody = document.querySelector("#auditTable tbody");
  tbody.innerHTML = "";
  pageLogs.forEach(row => {
    tbody.innerHTML += `<tr>
      <td>${row.username}</td>
      <td>${row.action}</td>
      <td>${row.timestamp}</td>
    </tr>`;
  });
  let pagDiv = document.getElementById("auditPagination");
  if (totalPages > 1) {
    pagDiv.innerHTML = `
      <button onclick="changeAuditPage(1)" ${auditPage===1?"disabled":""}>&lt;&lt;</button>
      <button onclick="changeAuditPage(${auditPage-1})" ${auditPage===1?"disabled":""}>&lt;</button>
      Page ${auditPage} of ${totalPages}
      <button onclick="changeAuditPage(${auditPage+1})" ${auditPage===totalPages?"disabled":""}>&gt;</button>
      <button onclick="changeAuditPage(${totalPages})" ${auditPage===totalPages?"disabled":""}>&gt;&gt;</button>
    `;
  } else {
    pagDiv.innerHTML = "";
  }
}
function changeAuditPage(newPage) {
  auditPage = newPage;
  renderAuditLog();
}
function renderUsageAudit() {
  const logs = usageAuditData || [];
  const totalPages = Math.max(1, Math.ceil(logs.length / usageRowsPerPage));
  if (usagePage > totalPages) usagePage = totalPages;
  const start = (usagePage - 1) * usageRowsPerPage;
  const end = start + usageRowsPerPage;
  const pageLogs = logs.slice(start, end);
  let tbody = document.querySelector("#usageAuditTable tbody");
  tbody.innerHTML = "";
  pageLogs.forEach(row => {
    tbody.innerHTML += `<tr>
      <td>${row.username}</td>
      <td>${row.action}</td>
      <td>${row.patient_id || ""}</td>
      <td>${row.timestamp}</td>
    </tr>`;
  });
  let pagDiv = document.getElementById("usagePagination");
  if (totalPages > 1) {
    pagDiv.innerHTML = `
      <button onclick="changeUsagePage(1)" ${usagePage===1?"disabled":""}>&lt;&lt;</button>
      <button onclick="changeUsagePage(${usagePage-1})" ${usagePage===1?"disabled":""}>&lt;</button>
      Page ${usagePage} of ${totalPages}
      <button onclick="changeUsagePage(${usagePage+1})" ${usagePage===totalPages?"disabled":""}>&gt;</button>
      <button onclick="changeUsagePage(${totalPages})" ${usagePage===totalPages?"disabled":""}>&gt;&gt;</button>
    `;
  } else {
    pagDiv.innerHTML = "";
  }
}
function changeUsagePage(newPage) {
  usagePage = newPage;
  renderUsageAudit();
}
function loadAuditLog() {
  fetchJson(AUDIT_API).then(logs => {
    auditData = logs;
    auditPage = 1;
    renderAuditLog();
  });
}
function loadUsageAudit() {
  fetchJson(USAGE_API).then(logs => {
    usageAuditData = logs;
    usagePage = 1;
    renderUsageAudit();
  });
}

// ========== Table and Analytics ==========

// Reason for deviation
function syncDeviationReason() {
  var sel = document.getElementById('reason_for_deviation_select');
  var txt = document.getElementById('reason_for_deviation_text');
  if (sel.value === "Others") {
    txt.value = "";
    txt.disabled = false;
    txt.focus();
  } else if (sel.value) {
    txt.value = sel.value;
    txt.disabled = false;
  } else {
    txt.value = "";
    txt.disabled = true;
  }
}

function fetchData() {
  Promise.all([
    fetchJson(PATIENT_API),
    userRole === "admin" ? fetchJson(USERS_API) : Promise.resolve([]),
    userRole === "admin" ? fetchJson(AUDIT_API) : Promise.resolve([]),
    userRole === "admin" ? fetchJson(USAGE_API) : Promise.resolve([])
  ]).then(([data, users, audit, usage]) => {
    tableData = data;
    if (userRole === "admin") {
      usersData = users; auditData = audit; usageAuditData = usage;
      renderUserTable(); renderAuditLog(); renderUsageAudit();
    }
    updateTable(); updateStats(); updatePie(); updateBar();
  });
}

function updateTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";
  const complianceFilter = document.getElementById("filterCompliance").value;
  const consultantFilter = document.getElementById("filterConsultant").value;
  const searchPID = document.getElementById("searchPID").value.trim().toLowerCase();
  let displayData = tableData.map(row => {
    const compObj = calcComplianceNCType(row);
    row.compliance_status = compObj.compliance;
    row.nc_type = compObj.ncType || "";
    row.reason_for_deviation = row.reason_for_deviation || "";
    return row;
  }).filter(row => {
    if (complianceFilter && row.compliance_status !== complianceFilter) return false;
    if (consultantFilter && row.consultant !== consultantFilter) return false;
    if (searchPID && (!row.patient_id || !row.patient_id.toLowerCase().includes(searchPID))) return false;
    return true;
  });
  const totalPages = Math.max(1, Math.ceil(displayData.length / rowsPerPage));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pagedData = displayData.slice(start, end);
  pagedData.forEach((row, idx) => {
    const rowId = `row_${start + idx}`;
    const whatsappLink = row.phone_number ? `<a class="whatsapp-link" href="https://wa.me/91${row.phone_number}" target="_blank" title="Message on WhatsApp"><img src="https://img.icons8.com/color/48/000000/whatsapp--v1.png"/></a>` : '';
    // Color code C/NC
    let complianceCellStyle = row.compliance_status === "C" ? "background:#e0ffe0;" : row.compliance_status === "NC" ? "background:#fff0e0;" : "";
    // Color code NC type
    let ncTypeStyle = "";
    if (row.nc_type==="Modality NC") ncTypeStyle="background:#a5d8ff;";
    if (row.nc_type==="Delay NC") ncTypeStyle="background:#ffd6a5;";
    if (row.nc_type==="Modality + Delay NC") ncTypeStyle="background:#e0b3ff;";
    let deleteBtnHtml = (userRole === "admin") ? `<button class="delete-btn" onclick='deleteEntry("${row.patient_id}")'>Delete</button>` : "";
    tbody.innerHTML += `
      <tr id="${rowId}" style="cursor:pointer">
        <td>${row.patient_id || ""}</td>
        <td>${row.phone_number || ""} ${whatsappLink}</td>
        <td>${row.consultant || ""}</td>
        <td>${row.primary_tumour_site || ""}</td>
        <td>${row.t_stage || ""}</td>
        <td>${row.n_stage || ""}</td>
        <td>${row.m_stage || ""}</td>
        <td>${row.tnm || ""}</td>
        <td>${row.date_of_registration || ""}</td>
        <td>${row.dmg || ""}</td>
        <td>${row.dmg_date || ""}</td>
        <td>${row.actual_treatment || ""}</td>
        <td>${row.actual_treatment_start_date || ""}</td>
        <td>${row.date_of_surgery || ""}</td>
        <td>${row.date_of_starting_adjuvant_rt || ""}</td>
        <td>${row.tat || ""}</td>
        <td style="${complianceCellStyle}">${row.compliance_status || ""}</td>
        <td style="${ncTypeStyle}">${row.nc_type || ""}</td>
        <td>${row.reason_for_deviation || ""}</td>
        <td>${row.date_of_completion_of_treatment || ""}</td>
        <td>
          <div class="actions-btn">
            <button class="edit-btn" onclick='editEntry("${row.patient_id}")'>Edit</button>
            ${deleteBtnHtml}
          </div>
        </td>
      </tr>
    `;
  });
  // Row click for highlight, dblclick for edit
  pagedData.forEach((row, idx) => {
    const rowElem = document.getElementById(`row_${start + idx}`);
    rowElem.onclick = function() {
      if (lastSelectedRow) lastSelectedRow.classList.remove("selected-row");
      rowElem.classList.add("selected-row");
      lastSelectedRow = rowElem;
    };
    rowElem.ondblclick = function() {
      editEntry(row.patient_id);
      window.scrollTo({top:0, behavior:"smooth"});
    };
  });
  let pagDiv = document.getElementById("pagination");
  pagDiv.innerHTML = `
    <button onclick="gotoPage(1)" ${currentPage === 1 ? "disabled" : ""}>&lt;&lt;</button>
    <button onclick="gotoPage(${currentPage-1})" ${currentPage === 1 ? "disabled" : ""}>&lt;</button>
    Page ${currentPage} of ${totalPages}
    <button onclick="gotoPage(${currentPage+1})" ${currentPage === totalPages ? "disabled" : ""}>&gt;</button>
    <button onclick="gotoPage(${totalPages})" ${currentPage === totalPages ? "disabled" : ""}>&gt;&gt;</button>
  `;
}
function gotoPage(page) { currentPage = page; updateTable(); }

// Analytics with all 3 medians
function updateStats() {
  let tatArr = [], surgRTArr = [], rtWaitArr = [];
  tableData.forEach(row => {
    if (row.date_of_registration && row.dmg_date) {
      let tat = dateDiff(row.date_of_registration, row.dmg_date);
      if (!isNaN(tat)) tatArr.push(tat);
    }
    if (row.date_of_surgery && row.date_of_starting_adjuvant_rt) {
      let surgRT = dateDiff(row.date_of_surgery, row.date_of_starting_adjuvant_rt);
      if (!isNaN(surgRT)) surgRTArr.push(surgRT);
    }
    if ((row.dmg === "Def RT" || row.dmg === "Def RT+CT") &&
        row.dmg_date && row.actual_treatment_start_date) {
      let rtWait = dateDiff(row.dmg_date, row.actual_treatment_start_date);
      if (!isNaN(rtWait)) rtWaitArr.push(rtWait);
    }
  });
  document.getElementById('statsDiv').innerHTML =
    `Median TAT: ${median(tatArr)} days &nbsp; | &nbsp; 
     Median Surgery-to-RT Interval: ${median(surgRTArr)} days &nbsp; | &nbsp; 
     Median RT Waiting: ${median(rtWaitArr)} days`;
}

// Pie/Bar Chart
let pie, bar;
function updatePie() {
  const ctx = document.getElementById('pieChart').getContext('2d');
  const countC = tableData.filter(r => calcComplianceNCType(r).compliance === "C").length;
  const countNC = tableData.filter(r => calcComplianceNCType(r).compliance === "NC").length;
  if (pie) pie.destroy();
  pie = new Chart(ctx, {
    type: "pie",
    data: {
      labels: ["Compliance", "Non-Compliance"],
      datasets: [{
        data: [countC, countNC],
        backgroundColor: [
          "#a8dadc", // pastel teal
          "#cdb4db"  // pastel lavender
        ],
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
          color: "#333",
          formatter: (value, ctx) => {
            const sum = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
            const percent = sum ? (100 * value / sum).toFixed(1) : 0;
            return percent + "%";
          },
          font: { weight: "bold", size: 16 }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}
function updateBar() {
  const ctx = document.getElementById('barChart').getContext('2d');
  const consultants = [
    "Dr A.K. Das", "Dr R.J. Das", "Dr T Rahman",
    "Dr. K.Das", "Dr A. Das", "Dr. K. Kakati"
  ];
  const comp = consultants.map(c => tableData.filter(r => calcComplianceNCType(r).compliance === "C" && r.consultant === c).length);
  const ncomp_mod = consultants.map(c => tableData.filter(r => calcComplianceNCType(r).ncType === "Modality NC" && r.consultant === c).length);
  const ncomp_delay = consultants.map(c => tableData.filter(r => calcComplianceNCType(r).ncType === "Delay NC" && r.consultant === c).length);
  const ncomp_both = consultants.map(c => tableData.filter(r => calcComplianceNCType(r).ncType === "Modality + Delay NC" && r.consultant === c).length);
  if (bar) bar.destroy();
  bar = new Chart(ctx, {
    type: "bar",
    data: {
      labels: consultants,
      datasets: [
        { label: "Compliance", data: comp, backgroundColor: "#a8dadc" },
        { label: "Modality NC", data: ncomp_mod, backgroundColor: "#a5d8ff" },
        { label: "Delay NC", data: ncomp_delay, backgroundColor: "#ffd6a5" },
        { label: "Modality + Delay NC", data: ncomp_both, backgroundColor: "#e0b3ff" }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      },
      scales: {
        y: { beginAtZero: true, precision:0 }
      }
    }
  });
}

function showFormAlert(msg, warn) {
  let el = document.getElementById('formAlert');
  el.innerText = msg;
  el.style.display = 'block';
  el.style.background = warn ? "#e74c3c" : "#2878bb";
}
function hideFormAlert() { document.getElementById('formAlert').style.display = 'none'; }
document.getElementById('filterCompliance').onchange = updateTable;
document.getElementById('filterConsultant').onchange = updateTable;
document.getElementById('searchPID').oninput = updateTable;
document.getElementById('addNewBtn').onclick = function() {
  document.getElementById('entryForm').reset();
  editMode = false;
  editRowId = null;
  document.getElementById("submitBtn").value = "Add";
  autoCalcForm();
  hideFormAlert();
  window.scrollTo({top:0, behavior:"smooth"});
};
// Editing & form (unchanged except for compliance/NC type auto)
function editEntry(pid) {
  let row = tableData.find(r => r.patient_id === pid);
  if (!row) return;
  let form = document.getElementById('entryForm');
  Object.keys(row).forEach(key => { if (form[key]) form[key].value = row[key] || ""; });
  let sel = document.getElementById('reason_for_deviation_select');
  let txt = document.getElementById('reason_for_deviation_text');
  let matched = false;
  for (let i = 1; i < sel.options.length; i++) {
    if (row.reason_for_deviation === sel.options[i].value) {
      sel.value = row.reason_for_deviation;
      txt.value = sel.value;
      matched = true;
      break;
    }
  }
  if (!matched) {
    sel.value = "Others";
    txt.value = row.reason_for_deviation || "";
  }
  sel.disabled = false;
  txt.disabled = false;
  editMode = true; editRowId = pid;
  document.getElementById("submitBtn").value = "Update";
  autoCalcForm();
  window.scrollTo({top:0, behavior:"smooth"});
}
function deleteEntry(pid) {
  if (!confirm("Delete this entry?")) return;
  fetch(`${PATIENT_API}&patient_id=${encodeURIComponent(pid)}`, { method: "DELETE" })
    .then(() => { fetchData();
  applyDateRestrictions(); postUsageAudit("delete", pid); });
}
document.getElementById('entryForm').addEventListener('input', autoCalcForm);
function autoCalcForm() {
  const t = document.getElementById('t_stage').value;
  const n = document.getElementById('n_stage').value;
  const m = document.getElementById('m_stage').value;
  document.getElementById('tnm').value = (t && n && m) ? `${t}${n}${m}` : "";
  const d1 = document.getElementById('date_of_registration').value;
  const d2 = document.getElementById('dmg_date').value;
  document.getElementById('tat').value = (d1 && d2 && !isNaN(dateDiff(d1, d2))) ? dateDiff(d1, d2) : "";
  let compliance = "C";
  let modalityNC = false, delayNC = false;
  let planned = document.getElementById('dmg').value;
  let actual = document.getElementById('actual_treatment').value;
  let plannedStart = document.getElementById('dmg_date').value;
  let actualStart = document.getElementById('actual_treatment_start_date').value;
  let surg = document.getElementById('date_of_surgery').value;
  let adjrt = document.getElementById('date_of_starting_adjuvant_rt').value;
  const today = todayStr();
  if (planned && actual && planned !== actual) modalityNC = true;
  if ((planned === "Def RT" || planned === "Def RT+CT") && plannedStart) {
    if (!actualStart && dateDiff(plannedStart, today) > 15) delayNC = true;
    if (actualStart && dateDiff(plannedStart, actualStart) > 15) delayNC = true;
  }
  if (planned === "Surgery" && plannedStart) {
    if (!surg && dateDiff(plannedStart, today) > 21) delayNC = true;
    if (surg && dateDiff(plannedStart, surg) > 21) delayNC = true;
  }
  if (surg && !adjrt && dateDiff(surg, today) > 42) delayNC = true;
  if (surg && adjrt && dateDiff(surg, adjrt) > 42) delayNC = true;
  if (actual && !planned) modalityNC = true;
  let ncType = "";
  if (modalityNC && delayNC) { compliance = "NC"; ncType = "Modality + Delay NC"; }
  else if (modalityNC) { compliance = "NC"; ncType = "Modality NC"; }
  else if (delayNC) { compliance = "NC"; ncType = "Delay NC"; }
  document.getElementById('compliance_status').value = compliance;
  document.getElementById('compliance_status').setAttribute('data-nc-type', ncType);

  // Enable/disable reason fields
  let selField = document.getElementById('reason_for_deviation_select');
  let txtField = document.getElementById('reason_for_deviation_text');
  if (compliance === "NC") {
    selField.disabled = false;
    txtField.disabled = false;
    selField.required = true;
    txtField.required = true;
  } else {
    selField.disabled = true;
    selField.value = "";
    txtField.disabled = true;
    txtField.value = "";
    selField.required = false;
    txtField.required = false;
  }
}
document.getElementById('entryForm').onsubmit = function(e) {
  e.preventDefault();

  let compliance = document.getElementById('compliance_status').value;
  let ncType = document.getElementById('compliance_status').getAttribute('data-nc-type') || "";
  if (compliance === "NC" && !document.getElementById('reason_for_deviation_text').value.trim()) {
    showFormAlert("Please provide a reason for deviation.", true);
    document.getElementById('reason_for_deviation_text').focus();
    return false;
  }
  let form = document.getElementById('entryForm');
  let newRow = {
    patient_id: form.patient_id.value.trim(),
    phone_number: form.phone_number.value.trim(),
    consultant: form.consultant.value,
    primary_tumour_site: form.primary_tumour_site.value,
    t_stage: form.t_stage.value,
    n_stage: form.n_stage.value,
    m_stage: form.m_stage.value,
    tnm: form.tnm.value,
    date_of_registration: form.date_of_registration.value,
    dmg: form.dmg.value,
    dmg_date: form.dmg_date.value,
    actual_treatment: form.actual_treatment.value,
    actual_treatment_start_date: form.actual_treatment_start_date.value,
    date_of_surgery: form.date_of_surgery.value,
    date_of_starting_adjuvant_rt: form.date_of_starting_adjuvant_rt.value,
    compliance_status: compliance,
    nc_type: (compliance === "NC" ? ncType : ""),
    reason_for_deviation: (compliance === "NC" ? document.getElementById('reason_for_deviation_text').value.trim() : ""),
    date_of_completion_of_treatment: form.date_of_completion_of_treatment.value,
    tat: form.tat.value
  };

  if (editMode && editRowId) {
    // PATCH block (edit/update)
    fetch(`${API_BASE}/patient_id/${encodeURIComponent(editRowId)}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: newRow })
    })
    .then(r => r.json())
    .then(resp => {
      console.log("SheetDB PATCH response:", resp);
      if (resp.updated === 1) {
        alert("Update successful!");
        editMode = false; editRowId = null; form.reset(); fetchData();
  applyDateRestrictions();
        document.getElementById("submitBtn").value = "Add";
      } else {
        alert("Update failed: SheetDB did not update any row! (updated: 0)\nCheck patient_id and Sheet carefully.");
        console.log("DEBUG: Tried to update patient_id:", editRowId, "with data:", newRow);
      }
    })
    .catch(e => {
      alert("PATCH error: " + e);
      console.error("PATCH error:", e);
    });
  } else {
    // POST block (add new)
    if (tableData.some(row => row.patient_id === newRow.patient_id)) {
      showFormAlert("Patient ID already exists."); return false;
    }
    fetch(PATIENT_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: newRow })
    }).then(() => { 
      form.reset(); fetchData();
  applyDateRestrictions(); document.getElementById("submitBtn").value = "Add";
    });
    showFormAlert("Entry submitted!", false);
    setTimeout(hideFormAlert, 2000);
  }
};

function downloadExcel() {
  if(userRole !== "admin") return;
  let exportData = tableData.map(row => ({
    "Patient ID": row.patient_id,
    "Phone Number": row.phone_number,
    "Consultant": row.consultant,
    "Primary Tumour Site": row.primary_tumour_site,
    "T": row.t_stage,
    "N": row.n_stage,
    "M": row.m_stage,
    "TNM": row.tnm,
    "Date of Registration": row.date_of_registration,
    "DMG": row.dmg,
    "DMG Date": row.dmg_date,
    "Actual Treatment": row.actual_treatment,
    "Actual Start": row.actual_treatment_start_date,
    "Date of Surgery": row.date_of_surgery,
    "Date of Starting Adjuvant RT": row.date_of_starting_adjuvant_rt,
    "TAT (days)": row.tat,
    "Compliance Status": row.compliance_status,
    "NC Type": row.nc_type,
    "Reason for Deviation": row.reason_for_deviation || "",
    "Date of Completion": row.date_of_completion_of_treatment
  }));
  let ws = XLSX.utils.json_to_sheet(exportData);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DMG Data");
  XLSX.writeFile(wb, "DMG_Dashboard.xlsx");
}
</script>
</body>
</html>
