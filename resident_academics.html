<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Resident Academic Activity Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" rel="stylesheet" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7fafd; margin: 0; padding: 0; }
    .container { max-width: 1100px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 16px; box-shadow: 0 4px 20px #2a2a2a12; }
    h1, h2 { color: #204080; margin-bottom: 12px; }
    .flex { display: flex; gap: 30px; flex-wrap: wrap; }
    .card { background: #e8eefa; padding: 18px 22px; border-radius: 12px; box-shadow: 0 2px 12px #0001; margin-bottom: 20px; }
    .card h2 { font-size: 1.15em; margin: 0 0 8px 0; }
    .btn { background: #204080; color: #fff; border: none; padding: 7px 16px; border-radius: 6px; cursor: pointer; font-size: 1em; margin: 2px 0; }
    .btn:hover { background: #2a50a0; }
    .manual-btn { background: #6c40a0; }
    .manual-btn:hover { background: #8a64d1; }
    .danger-btn { background: #a04040; }
    .danger-btn:hover { background: #c06060; }
    .table-scroll { overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; margin: 0 0 12px 0; }
    th, td { padding: 8px 7px; border: 1px solid #e3e8f2; font-size: 1em; }
    th { background: #f0f3fa; color: #204080; }
    tr.seminar-row { background: #f5f0ff !important; }
    tr.journal-row { background: #e8f8ff !important; }
    tr.audit-row { background: #fff8e3 !important; }
    .fc-event.seminar { background-color: #8e5fff !important; border: none !important; }
    .fc-event.journal { background-color: #22b7d9 !important; border: none !important; }
    .fc-event.audit { background-color: #ffe477 !important; color: #856800 !important; border: none !important; }
    select, input[type="text"], input[type="date"] { padding: 4px 6px; border-radius: 4px; border: 1px solid #d6dbe8; margin-right: 8px; }
    .fc-toolbar-title { font-size: 1.15em; }
    .hidden { display: none !important; }
    .subtle { color:#667; font-size: 0.9em; }
    @media (max-width: 900px) { .flex { flex-direction: column; gap: 0; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Resident Academic Activity Dashboard <span class="subtle">· Stable v1.2</span></h1>

    <div class="card flex" style="align-items:center; justify-content:space-between;">
      <div>
        <label>Filter by Resident:
          <select id="filterResident"><option value="">All</option></select>
        </label>
        <label>Activity:
          <select id="filterActivity"><option value="">All</option><option>Seminar</option><option>Journal Club</option><option>Audit</option></select>
        </label>
        <label>Status:
          <select id="filterStatus"><option value="">All</option><option>Completed</option><option>Pending</option><option>Cancelled</option></select>
        </label>
        <button class="btn" onclick="resetFilters()">Reset</button>
        <button class="danger-btn btn" onclick="cleanupDuplicates()">Remove Duplicates</button>
      </div>
      <div>
        <button class="btn" onclick="generateActivities()">Generate Activities (4 months)</button>
        <button class="btn" onclick="autoAllocate()">Auto Allocate</button>
        <button class="manual-btn btn" onclick="openManualAllocate()">Manual Allocate</button>
      </div>
    </div>

    <div class="card" id="upcomingCard">
      <h2>Upcoming Activities (Next 3)</h2>
      <ul id="upcomingList"></ul>
    </div>

    <div class="card">
      <h2>Monthly Calendar</h2>
      <div id="calendar"></div>
    </div>

    <div class="card table-scroll">
      <h2>All Activities</h2>
      <table id="activityTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Activity</th>
            <th>Topic</th>
            <th>Resident</th>
            <th>Status</th>
            <th>FileLink</th>
            <th>Feedback</th>
            <th>Comments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="subtle">* Calendar and table auto-dedupe by Date+Activity when rendering.</div>
    </div>

    <!-- Upload/Edit Modal -->
    <div id="modal" class="hidden" style="position:fixed; left:0;top:0; width:100vw;height:100vh; background:rgba(50,60,80,0.15); display:flex; align-items:center; justify-content:center; z-index:100;">
      <div style="background:#fff; padding:28px 32px; border-radius:10px; min-width:340px; box-shadow:0 2px 12px #0004; position:relative;">
        <h2 id="modalTitle">Edit/Upload</h2>
        <form id="editForm">
          <input type="hidden" id="editRowId">
          <div><label>Date: <input type="date" id="editDate" required></label></div>
          <div><label>Activity:
            <select id="editActivity" required>
              <option>Seminar</option>
              <option>Journal Club</option>
              <option>Audit</option>
            </select>
          </label></div>
          <div><label>Topic: <input type="text" id="editTopic" required></label></div>
          <div><label>Resident:
            <select id="editResident" required></select>
          </label></div>
          <div><label>Status:
            <select id="editStatus" required>
              <option>Pending</option>
              <option>Completed</option>
              <option>Cancelled</option>
            </select>
          </label></div>
          <div><label>File Link: <input type="text" id="editFileLink" placeholder="Paste Google Drive/Dropbox/OneDrive URL"></label></div>
          <div><label>Feedback: <input type="text" id="editFeedback"></label></div>
          <div><label>Comments: <input type="text" id="editComments"></label></div>
          <br>
          <button class="btn" type="submit">Save</button>
          <button class="btn" type="button" onclick="closeModal()">Cancel</button>
        </form>
        <span style="position:absolute;right:20px;top:14px;cursor:pointer;font-size:1.2em;" onclick="closeModal()">&times;</span>
      </div>
    </div>

    <!-- Manual Allocate Modal -->
    <div id="manualModal" class="hidden" style="position:fixed; left:0;top:0; width:100vw;height:100vh; background:rgba(50,60,80,0.15); display:flex; align-items:center; justify-content:center; z-index:101;">
      <div style="background:#fff; padding:26px 24px; border-radius:10px; min-width:340px; box-shadow:0 2px 12px #0004; position:relative;">
        <h2>Manual Allocation</h2>
        <form id="manualForm">
          <div><label>Select Activity:
            <select id="manualActivity"></select>
          </label></div>
          <div><label>Assign Resident:
            <select id="manualResident"></select>
          </label></div>
          <div><label>Edit Topic:
            <input type="text" id="manualTopic">
          </label></div>
          <br>
          <button class="btn" type="submit">Assign</button>
          <button class="btn" type="button" onclick="closeManualModal()">Cancel</button>
        </form>
        <span style="position:absolute;right:20px;top:14px;cursor:pointer;font-size:1.2em;" onclick="closeManualModal()">&times;</span>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
  <script>
const SHEETDB_API_GET = "https://sheetdb.io/api/v1/bujxq0iah3mw5?limit=1000";
const SHEETDB_API = "https://sheetdb.io/api/v1/bujxq0iah3mw5";
const RESIDENTS = [
  "Dr Deeksha Sharma",
  "Dr Rupjyoti Das",
  "Dr Prakash Sutar",
  "Dr Soumya Jee",
  "Dr Kanishk",
  "Dr Yamuna",
  "Dr Ardent",
  "Dr Dibit Goel"
  "Dr Tushar Deka"
];

let allData = [];
let filteredData = [];
let activeRowId = null;
let calendar = null;

async function fetchActivities() {
  const res = await fetch(SHEETDB_API_GET);
  allData = await res.json();
  filteredData = [...allData];
  renderResidentDropdowns();
  renderUpcoming();
  renderActivityTable();
  renderCalendar();
  renderFilters();
}

function renderResidentDropdowns() {
  let options = '<option value="">All</option>';
  RESIDENTS.forEach(name => { options += `<option>${name}</option>`; });
  document.getElementById("filterResident").innerHTML = options;

  let rOptions = '';
  RESIDENTS.forEach(name => { rOptions += `<option>${name}</option>`; });
  document.getElementById("editResident").innerHTML = rOptions;
  document.getElementById("manualResident").innerHTML = rOptions;
}

function renderFilters() {
  document.getElementById("filterResident").onchange = filterTable;
  document.getElementById("filterActivity").onchange = filterTable;
  document.getElementById("filterStatus").onchange = filterTable;
}
function resetFilters() {
  document.getElementById("filterResident").value = "";
  document.getElementById("filterActivity").value = "";
  document.getElementById("filterStatus").value = "";
  filterTable();
}
function filterTable() {
  const resident = document.getElementById("filterResident").value;
  const activity = document.getElementById("filterActivity").value;
  const status = document.getElementById("filterStatus").value;
  filteredData = allData.filter(row =>
    (!resident || row.Resident === resident) &&
    (!activity || row.Activity === activity) &&
    (!status || row.Status === status)
  );
  renderUpcoming();
  renderActivityTable();
  renderCalendar();
}

/* ---------- WEEKDAY RULE HELPERS (enforce academic schedule) ---------- */
function isWed(d){ const dt = new Date(d); return dt.getDay() === 3; } // 0=Sun..6=Sat
function isThu(d){ const dt = new Date(d); return dt.getDay() === 4; }
function isFirstWed(d){ const dt = new Date(d); return dt.getDay() === 3 && dt.getDate() <= 7; }

// Accept only: Seminar = Wed (not 1st Wed), Journal Club = Thu, Audit = 1st Wed
function isValidAcademicRow(row){
  if (!row || !row.Date || !row.Activity) return false;
  if (row.Activity === "Seminar") { const dt = new Date(row.Date); return dt.getDay() === 3 && dt.getDate() > 7; }
  if (row.Activity === "Journal Club") return isThu(row.Date);
  if (row.Activity === "Audit") return isFirstWed(row.Date);
  return false;
}
/* --------------------------------------------------------------------- */

function renderUpcoming() {
  const ul = document.getElementById("upcomingList");
  ul.innerHTML = "";

  const today = new Date();
  today.setHours(0,0,0,0);

  // future + valid weekday rows
  const futureRows = filteredData
    .filter(r => r.Date && new Date(r.Date) >= today)
    .filter(isValidAcademicRow);

  // Deduplicate by Date+Activity (pick best with Topic/Resident filled)
  const score = r => (r.Topic ? 1 : 0) + (r.Resident ? 1 : 0);
  const byKey = {};
  futureRows.forEach(r => {
    const key = `${r.Date}|${r.Activity}`;
    byKey[key] = byKey[key] ? (score(r) > score(byKey[key]) ? r : byKey[key]) : r;
  });

  // Next 3
  const upNext = Object.values(byKey)
    .sort((a, b) => new Date(a.Date) - new Date(b.Date))
    .slice(0, 3);

  upNext.forEach(row => {
    const li = document.createElement("li");
    li.innerHTML = `${row.Activity} <b>(${row.Topic || ""})</b> – ${row.Resident || ""} – <span style="color:#204080">${row.Date}</span>
      <button class="btn" onclick="openModal('${row.id}')">Edit/Upload</button>`;
    ul.appendChild(li);
  });

  if (upNext.length === 0) ul.innerHTML = "<li>No upcoming activities.</li>";
}

function renderActivityTable() {
  const tbody = document.querySelector("#activityTable tbody");
  tbody.innerHTML = "";
  // Optional dedupe in table as well (keeps the best)
  const byKey = {};
  const score = r => (r.Topic ? 1 : 0) + (r.Resident ? 1 : 0);
  filteredData.forEach(row => {
    const key = row.Date && row.Activity ? `${row.Date}|${row.Activity}` : null;
    if (!key) return;
    if (!byKey[key] || score(row) > score(byKey[key])) byKey[key] = row;
  });

  Object.values(byKey).forEach(row => {
    let tr = document.createElement("tr");
    let rowClass = row.Activity === "Seminar" ? "seminar-row" :
                   row.Activity === "Journal Club" ? "journal-row" : "audit-row";
    tr.className = rowClass;
    tr.innerHTML = `
      <td>${row.Date || ""}</td>
      <td>${row.Activity || ""}</td>
      <td>${row.Topic || ""}</td>
      <td>${row.Resident || ""}</td>
      <td>${row.Status || ""}</td>
      <td>${row.FileLink ? `<a href="${row.FileLink}" target="_blank">View</a>` : ""}</td>
      <td>${row.Feedback || ""}</td>
      <td>${row.Comments || ""}</td>
      <td>
        <button class="btn" onclick="openModal('${row.id}')"><i class="fa fa-pen"></i> Edit</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function renderCalendar() {
  if (calendar) { calendar.destroy(); }
  const calendarEl = document.getElementById('calendar');
  if (!filteredData || filteredData.length === 0) {
    calendarEl.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:40px;">No activities to show on calendar.</div>';
    return;
  }

  // Enforce weekday rules first
  const validRows = filteredData.filter(isValidAcademicRow);

  // DEDUPE for Calendar: keep only one row per Date+Activity (prefer Topic/Resident filled)
  const pickBest = (a, b) => {
    const score = r => (r.Topic ? 1 : 0) + (r.Resident ? 1 : 0);
    return (score(b) > score(a)) ? b : a;
  };
  const byKey = {};
  validRows.forEach(row => {
    const key = `${row.Date}|${row.Activity}`;
    byKey[key] = byKey[key] ? pickBest(byKey[key], row) : row;
  });

  const events = Object.values(byKey).map(row => {
    let className = row.Activity === "Seminar" ? "seminar"
                  : row.Activity === "Journal Club" ? "journal"
                  : "audit";
    return {
      title: `${row.Activity}: ${row.Topic || ""} (${row.Resident || ""})`,
      start: row.Date,
      className,
      extendedProps: { ...row }
    };
  });

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 500,
    events,
    eventClick: function(info) {
      openModal(info.event.extendedProps.id || "");
    }
  });
  calendar.render();
}

function openModal(rowId) {
  let row = allData.find(r => String(r.id) === String(rowId));
  if (!row) row = { Date: "", Activity: "Seminar", Topic: "", Resident: RESIDENTS[0], Status: "Pending", FileLink: "", Feedback: "", Comments: "", id: "" };
  activeRowId = row.id;
  document.getElementById("editRowId").value = activeRowId;
  document.getElementById("editDate").value = row.Date || "";
  document.getElementById("editActivity").value = row.Activity || "Seminar";
  document.getElementById("editTopic").value = row.Topic || "";
  document.getElementById("editResident").value = row.Resident || RESIDENTS[0];
  document.getElementById("editStatus").value = row.Status || "Pending";
  document.getElementById("editFileLink").value = row.FileLink || "";
  document.getElementById("editFeedback").value = row.Feedback || "";
  document.getElementById("editComments").value = row.Comments || "";
  document.getElementById("modal").classList.remove("hidden");
}
function closeModal() {
  document.getElementById("modal").classList.add("hidden");
}
window.onload = function() {
  fetchActivities();
  document.getElementById("modal").addEventListener("click", function(e) {
    if (e.target === this) closeModal();
  });
  document.getElementById("manualModal").addEventListener("click", function(e) {
    if (e.target === this) closeManualModal();
  });
};
document.getElementById("editForm").onsubmit = async function(e) {
  e.preventDefault();
  let idx = allData.findIndex(r => String(r.id) === String(activeRowId));
  if (idx === -1) { alert("Row not found"); return; }
  const updated = {
    Date: document.getElementById("editDate").value,
    Activity: document.getElementById("editActivity").value,
    Topic: document.getElementById("editTopic").value,
    Resident: document.getElementById("editResident").value,
    Status: document.getElementById("editStatus").value,
    FileLink: document.getElementById("editFileLink").value,
    Feedback: document.getElementById("editFeedback").value,
    Comments: document.getElementById("editComments").value
  };
  try {
    await fetch(`${SHEETDB_API}/id/${activeRowId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: updated })
    });
    Object.assign(allData[idx], updated);
    filterTable();
    closeModal();
  } catch (err) {
    alert("Failed to update activity! " + err);
  }
};

function shuffle(array) {
  let arr = array.slice();
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Robust autoAllocate
async function autoAllocate() {
  // Only allocate Seminar if NOT the 1st Wednesday of the month
  let seminarRows = allData.filter(row =>
    row.Activity === "Seminar" &&
    row.Date &&
    new Date(row.Date).getDay() === 3 &&         // Wednesday
    new Date(row.Date).getDate() > 7             // Not 1st Wednesday
  ).sort((a, b) => new Date(row.Date) - new Date(a.Date));

  let jcRows = allData.filter(row =>
    row.Activity === "Journal Club" &&
    row.Date &&
    new Date(row.Date).getDay() === 4            // Thursday
  ).sort((a, b) => new Date(row.Date) - new Date(a.Date));

  let n = RESIDENTS.length;
  let seminarIndex = 0;
  let jcIndex = 0;
  let success = 0, fail = 0;

  // 1. Allocate Seminar: 2-week gap for each resident (cycle list every n*2 weeks)
  for (let i = 0; i < seminarRows.length; i++) {
    let resident = RESIDENTS[seminarIndex % n];
    seminarIndex++;
    try {
      let response = await fetch(`${SHEETDB_API}/id/${seminarRows[i].id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: { Resident: resident } })
      });
      let result = await response.json();
      if (result.updated === 1) success++;
      else fail++;
    } catch (err) { fail++; }
    if ((seminarIndex) % n === 0) seminarIndex += n; // skip n weeks after each full cycle
  }

  // 2. Allocate JC: same 2-week gap for each resident
  for (let i = 0; i < jcRows.length; i++) {
    let resident = RESIDENTS[jcIndex % n];
    jcIndex++;
    try {
      let response = await fetch(`${SHEETDB_API}/id/${jcRows[i].id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: { Resident: resident } })
      });
      let result = await response.json();
      if (result.updated === 1) success++;
      else fail++;
    } catch (err) { fail++; }
    if ((jcIndex) % n === 0) jcIndex += n; // skip n weeks after each full cycle
  }

  // Don't assign Audit
  await fetchActivities();
  alert(`Auto-allocation finished! Success: ${success}, Fail: ${fail}`);
}

function openManualAllocate() {
  let options = "";
  allData.forEach(row => {
    options += `<option value="${row.id}">${row.Date} - ${row.Activity} (${row.Topic || ""}) [${row.Resident || ""}]</option>`;
  });
  document.getElementById("manualActivity").innerHTML = options;
  let rid = allData[0] ? allData[0].id : "";
  let row = allData.find(r => String(r.id) === String(rid));
  document.getElementById("manualResident").value = row ? row.Resident : RESIDENTS[0];
  document.getElementById("manualTopic").value = row ? row.Topic : "";
  document.getElementById("manualModal").classList.remove("hidden");
  document.getElementById("manualActivity").onchange = function() {
    let r = allData.find(x => String(x.id) === String(this.value));
    document.getElementById("manualResident").value = r ? r.Resident : RESIDENTS[0];
    document.getElementById("manualTopic").value = r ? r.Topic : "";
  };
}
function closeManualModal() {
  document.getElementById("manualModal").classList.add("hidden");
}

// --------- Generator for 4 months with DUPLICATE PREVENTION ---------
async function generateActivities() {
  if (!confirm("This will add 4 months of Seminar (Wed), JC (Thu), and Audit (first Wed) from next week. Proceed?")) return;

  const today = new Date();
  const nextWed = new Date(today);
  nextWed.setDate(nextWed.getDate() + ((3 - today.getDay() + 7) % 7)); // Next Wednesday
  const nextThu = new Date(today);
  nextThu.setDate(nextThu.getDate() + ((4 - today.getDay() + 7) % 7)); // Next Thursday

  // Build a fast lookup of EXISTING Date+Activity to avoid duplicates
  const existing = new Set(
    (allData || [])
      .filter(r => r.Date && r.Activity)
      .map(r => `${r.Date}|${r.Activity}`)
  );

  const activities = [];
  let id = Date.now();

  for (let w = 0; w < 16; w++) { // 16 weeks ~ 4 months
    let d1 = new Date(nextWed); d1.setDate(nextWed.getDate() + w*7);
    let d2 = new Date(nextThu); d2.setDate(nextThu.getDate() + w*7);
    const sDate = d1.toISOString().slice(0,10);
    const jDate = d2.toISOString().slice(0,10);

    // Seminar (Wednesday, not 1st)
    if (d1.getDay() === 3 && d1.getDate() > 7 && !existing.has(`${sDate}|Seminar`)) {
      activities.push({
        id: (id++).toString(),
        Date: sDate,
        Activity: "Seminar",
        Topic: "",
        Resident: "",
        Status: "Pending",
        FileLink: "",
        Feedback: "",
        Comments: ""
      });
      existing.add(`${sDate}|Seminar`);
    }
    // Journal Club (Thursday)
    if (d2.getDay() === 4 && !existing.has(`${jDate}|Journal Club`)) {
      activities.push({
        id: (id++).toString(),
        Date: jDate,
        Activity: "Journal Club",
        Topic: "",
        Resident: "",
        Status: "Pending",
        FileLink: "",
        Feedback: "",
        Comments: ""
      });
      existing.add(`${jDate}|Journal Club`);
    }
    // Audit (First Wednesday of month only)
    if (d1.getDay() === 3 && d1.getDate() <= 7 && !existing.has(`${sDate}|Audit`)) {
      activities.push({
        id: (id++).toString(),
        Date: sDate,
        Activity: "Audit",
        Topic: "Surgical Audit",
        Resident: "",
        Status: "Pending",
        FileLink: "",
        Feedback: "",
        Comments: ""
      });
      existing.add(`${sDate}|Audit`);
    }
  }

  try {
    for (const act of activities) {
      await fetch(SHEETDB_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: act })
      });
    }
    await fetchActivities();
    alert(`Activities for 4 months generated! Added: ${activities.length}.`);
  } catch (err) {
    alert("Failed to generate activities. " + err);
  }
}

// --------- One-click cleanup of EXISTING duplicates in SheetDB ---------
async function cleanupDuplicates() {
  if (!confirm("This will remove duplicate rows so only one entry per Date+Activity remains. Proceed?")) return;

  // Group rows by Date+Activity
  const groups = {};
  const score = r => (r.Topic ? 1 : 0) + (r.Resident ? 1 : 0);
  (allData || []).forEach(r => {
    if (!r.Date || !r.Activity) return;
    const key = `${r.Date}|${r.Activity}`;
    groups[key] = groups[key] || [];
    groups[key].push(r);
  });

  const toDelete = [];
  Object.values(groups).forEach(rows => {
    if (rows.length <= 1) return;
    // Keep the best (with Topic/Resident if available), delete others
    rows.sort((a, b) => score(b) - score(a)); // best first
    rows.slice(1).forEach(r => toDelete.push(r.id));
  });

  try {
    for (const id of toDelete) {
      await fetch(`${SHEETDB_API}/id/${id}`, { method: "DELETE" });
    }
    await fetchActivities();
    alert(`Cleanup complete. Removed ${toDelete.length} duplicate rows.`);
  } catch (e) {
    alert("Failed to cleanup duplicates: " + e);
  }
}
  </script>
</body>
</html>


