<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Resident Academic Activity Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" rel="stylesheet" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7fafd; margin: 0; padding: 0; }
    .container { max-width: 1100px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 16px; box-shadow: 0 4px 20px #2a2a2a12; }
    h1, h2 { color: #204080; margin-bottom: 12px; }
    .flex { display: flex; gap: 30px; flex-wrap: wrap; }
    .card { background: #e8eefa; padding: 18px 22px; border-radius: 12px; box-shadow: 0 2px 12px #0001; margin-bottom: 20px; }
    .card h2 { font-size: 1.15em; margin: 0 0 8px 0; }
    .btn { background: #204080; color: #fff; border: none; padding: 7px 16px; border-radius: 6px; cursor: pointer; font-size: 1em; margin: 2px 0; }
    .btn:hover { background: #2a50a0; }
    .manual-btn { background: #6c40a0; }
    .manual-btn:hover { background: #8a64d1; }
    .danger-btn { background: #a04040; }
    .danger-btn:hover { background: #c06060; }
    .table-scroll { overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; margin: 0 0 12px 0; }
    th, td { padding: 8px 7px; border: 1px solid #e3e8f2; font-size: 1em; }
    th { background: #f0f3fa; color: #204080; }
    tr.seminar-row { background: #f5f0ff !important; }
    tr.journal-row { background: #e8f8ff !important; }
    tr.audit-row { background: #fff8e3 !important; }
    .fc-event.seminar { background-color: #8e5fff !important; border: none !important; }
    .fc-event.journal { background-color: #22b7d9 !important; border: none !important; }
    .fc-event.audit { background-color: #ffe477 !important; color: #856800 !important; border: none !important; }
    select, input[type="text"], input[type="date"] { padding: 4px 6px; border-radius: 4px; border: 1px solid #d6dbe8; margin-right: 8px; }
    .fc-toolbar-title { font-size: 1.15em; }
    .hidden { display: none !important; }
    .subtle { color:#667; font-size: 0.9em; }

    /* Pagination */
    .pager { display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pager .info { margin-right:auto; color:#445; font-size:0.95em; }
    .pager button { background:#fff; color:#204080; border:1px solid #cdd6ee; padding:5px 10px; border-radius:6px; cursor:pointer; }
    .pager button:hover { background:#f3f6ff; }
    .pager button.active { background:#204080; color:#fff; border-color:#204080; }
    .pager button:disabled { opacity:.5; cursor:not-allowed; }
    .pager select { padding:4px 6px; border-radius:6px; border:1px solid #cdd6ee; }
    @media (max-width: 900px) { .flex { flex-direction: column; gap: 0; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Resident Academic Activity Dashboard <span class="subtle">· Stable v1.4</span></h1>

    <div class="card flex" style="align-items:center; justify-content:space-between;">
      <div>
        <label>Filter by Resident:
          <select id="filterResident"><option value="">All</option></select>
        </label>
        <label>Activity:
          <select id="filterActivity"><option value="">All</option><option>Seminar</option><option>Journal Club</option><option>Audit</option></select>
        </label>
        <label>Status:
          <select id="filterStatus"><option value="">All</option><option>Completed</option><option>Pending</option><option>Cancelled</option></select>
        </label>
        <button class="btn" onclick="resetFilters()">Reset</button>
        <button class="danger-btn btn" onclick="cleanupDuplicates()">Remove Duplicates</button>
      </div>
      <div>
        <button class="btn" onclick="generateActivities()">Generate Activities (4 months)</button>
        <button class="btn" onclick="autoAllocate()">Auto Allocate</button>
        <button class="manual-btn btn" onclick="openManualAllocate()">Manual Allocate</button>
      </div>
    </div>

    <div class="card" id="upcomingCard">
      <h2>Upcoming Activities (Next 3)</h2>
      <ul id="upcomingList"></ul>
    </div>

    <div class="card">
      <h2>Monthly Calendar</h2>
      <div id="calendar"></div>
    </div>

    <div class="card table-scroll">
      <h2>All Activities</h2>
      <div class="subtle" id="monthBadge"></div>
      <table id="activityTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Activity</th>
            <th>Topic</th>
            <th>Resident</th>
            <th>Status</th>
            <th>FileLink</th>
            <th>Feedback</th>
            <th>Comments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="pager" id="paginationBar"></div>
      <div class="subtle">* Table month is independent; use pager Prev/Next to move across months.</div>
    </div>

    <!-- Upload/Edit Modal -->
    <div id="modal" class="hidden" style="position:fixed; left:0;top:0; width:100vw;height:100vh; background:rgba(50,60,80,0.15); display:flex; align-items:center; justify-content:center; z-index:100;">
      <div style="background:#fff; padding:28px 32px; border-radius:10px; min-width:340px; box-shadow:0 2px 12px #0004; position:relative;">
        <h2 id="modalTitle">Edit/Upload</h2>
        <form id="editForm">
          <input type="hidden" id="editRowId">
          <div><label>Date: <input type="date" id="editDate" required></label></div>
          <div><label>Activity:
            <select id="editActivity" required>
              <option>Seminar</option>
              <option>Journal Club</option>
              <option>Audit</option>
            </select>
          </label></div>
          <div><label>Topic: <input type="text" id="editTopic" required></label></div>
          <div><label>Resident:
            <select id="editResident" required></select>
          </label></div>
          <div><label>Status:
            <select id="editStatus" required>
              <option>Pending</option>
              <option>Completed</option>
              <option>Cancelled</option>
            </select>
          </label></div>
          <div><label>File Link: <input type="text" id="editFileLink" placeholder="Paste Google Drive/Dropbox/OneDrive URL"></label></div>
          <div><label>Feedback: <input type="text" id="editFeedback"></label></div>
          <div><label>Comments: <input type="text" id="editComments"></label></div>
          <br>
          <button class="btn" type="submit">Save</button>
          <button class="btn" type="button" onclick="closeModal()">Cancel</button>
        </form>
        <span style="position:absolute;right:20px;top:14px;cursor:pointer;font-size:1.2em;" onclick="closeModal()">&times;</span>
      </div>
    </div>

    <!-- Manual Allocate Modal -->
    <div id="manualModal" class="hidden" style="position:fixed; left:0;top:0; width:100vw;height:100vh; background:rgba(50,60,80,0.15); display:flex; align-items:center; justify-content:center; z-index:101;">
      <div style="background:#fff; padding:26px 24px; border-radius:10px; min-width:340px; box-shadow:0 2px 12px #0004; position:relative;">
        <h2>Manual Allocation</h2>
        <form id="manualForm">
          <div><label>Select Activity:
            <select id="manualActivity"></select>
          </label></div>
          <div><label>Assign Resident:
            <select id="manualResident"></select>
          </label></div>
          <div><label>Edit Topic:
            <input type="text" id="manualTopic">
          </label></div>
          <br>
          <button class="btn" type="submit">Assign</button>
          <button class="btn" type="button" onclick="closeManualModal()">Cancel</button>
        </form>
        <span style="position:absolute;right:20px;top:14px;cursor:pointer;font-size:1.2em;" onclick="closeManualModal()">&times;</span>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
  <script>
const SHEETDB_API_GET = "https://sheetdb.io/api/v1/bujxq0iah3mw5?limit=1000";
const SHEETDB_API = "https://sheetdb.io/api/v1/bujxq0iah3mw5";
const RESIDENTS = [
  "Dr Deeksha Sharma",
  "Dr Rupjyoti Das",
  "Dr Prakash Sutar",
  "Dr Soumya Jee",
  "Dr Kanishk",
  "Dr Yamuna",
  "Dr Dibit Goel",
  "Dr Ardent"
];

let allData = [];
let filteredData = [];
let activeRowId = null;
let calendar = null;

/* Pagination & month state for the table */
let tablePage = 1;
let tablePageSize = 10;
let tableMonthIndex = (new Date()).getMonth(); // 0..11
let tableYear = (new Date()).getFullYear();

/* ---------- Utilities ---------- */
function monthName(dt){ return dt.toLocaleString(undefined, { month: 'long' }); }
function sameMonthYear(d, m, y){
  const x = new Date(d);
  return x.getMonth() === m && x.getFullYear() === y;
}
function shiftTableMonth(delta, goToLastPage=false){
  tableMonthIndex += delta;
  if (tableMonthIndex < 0){ tableMonthIndex = 11; tableYear--; }
  if (tableMonthIndex > 11){ tableMonthIndex = 0; tableYear++; }
  tablePage = goToLastPage ? -1 : 1; // -1 sentinel -> last page
  renderActivityTable();
}

/* ---------- Academic weekday rules ---------- */
function isWed(d){ const dt = new Date(d); return dt.getDay() === 3; } // 0..6
function isThu(d){ const dt = new Date(d); return dt.getDay() === 4; }
function isFirstWed(d){ const dt = new Date(d); return dt.getDay() === 3 && dt.getDate() <= 7; }
function isValidAcademicRow(row){
  if (!row || !row.Date || !row.Activity) return false;
  if (row.Activity === "Seminar") { const dt = new Date(row.Date); return dt.getDay() === 3 && dt.getDate() > 7; }
  if (row.Activity === "Journal Club") return isThu(row.Date);
  if (row.Activity === "Audit") return isFirstWed(row.Date);
  return false;
}

/* ---------- Fetch & Filters ---------- */
async function fetchActivities() {
  const res = await fetch(SHEETDB_API_GET);
  allData = await res.json();
  filteredData = [...allData];
  renderResidentDropdowns();
  renderUpcoming();
  renderActivityTable();
  renderCalendar();
  renderFilters();
}

function renderResidentDropdowns() {
  let options = '<option value="">All</option>';
  RESIDENTS.forEach(name => { options += `<option>${name}</option>`; });
  document.getElementById("filterResident").innerHTML = options;

  let rOptions = '';
  RESIDENTS.forEach(name => { rOptions += `<option>${name}</option>`; });
  document.getElementById("editResident").innerHTML = rOptions;
  document.getElementById("manualResident").innerHTML = rOptions;
}

function renderFilters() {
  document.getElementById("filterResident").onchange = () => { tablePage = 1; renderUpcoming(); renderActivityTable(); renderCalendar(); };
  document.getElementById("filterActivity").onchange = () => { tablePage = 1; renderUpcoming(); renderActivityTable(); renderCalendar(); };
  document.getElementById("filterStatus").onchange = () => { tablePage = 1; renderUpcoming(); renderActivityTable(); renderCalendar(); };
}
function resetFilters() {
  document.getElementById("filterResident").value = "";
  document.getElementById("filterActivity").value = "";
  document.getElementById("filterStatus").value = "";
  tablePage = 1;
  renderUpcoming();
  renderActivityTable();
  renderCalendar();
}

/* ---------- Upcoming ---------- */
function renderUpcoming() {
  const ul = document.getElementById("upcomingList");
  ul.innerHTML = "";

  const today = new Date();
  today.setHours(0,0,0,0);

  const futureRows = filteredData
    .filter(r => r.Date && new Date(r.Date) >= today)
    .filter(isValidAcademicRow);

  const score = r => (r.Topic ? 1 : 0) + (r.Resident ? 1 : 0);
  const byKey = {};
  futureRows.forEach(r => {
    const key = `${r.Date}|${r.Activity}`;
    byKey[key] = byKey[key] ? (score(r) > score(byKey[key]) ? r : byKey[key]) : r;
  });

  const upNext = Object.values(byKey)
    .sort((a, b) => new Date(a.Date) - new Date(b.Date))
    .slice(0, 3);

  upNext.forEach(row => {
    const li = document.createElement("li");
    li.innerHTML = `${row.Activity} <b>(${row.Topic || ""})</b> – ${row.Resident || ""} – <span style="color:#204080">${row.Date}</span>
      <button class="btn" onclick="openModal('${row.id}')">Edit/Upload</button>`;
    ul.appendChild(li);
  });

  if (upNext.length === 0) ul.innerHTML = "<li>No upcoming activities.</li>";
}

/* ---------- Table (CURRENT TABLE MONTH + Pagination that crosses months) ---------- */
function renderActivityTable() {
  const tbody = document.querySelector("#activityTable tbody");
  const badge = document.getElementById("monthBadge");
  tbody.innerHTML = "";

  const nowForBadge = new Date(tableYear, tableMonthIndex, 1);
  badge.innerHTML = `Showing: <b>${monthName(nowForBadge)} ${tableYear}</b>`;

  // Filter to current table month
  let monthRows = filteredData.filter(r => r.Date && sameMonthYear(r.Date, tableMonthIndex, tableYear));

  // Dedupe within month (prefer Topic/Resident filled)
  const score = r => (r.Topic ? 1 : 0) + (r.Resident ? 1 : 0);
  const byKey = {};
  monthRows.forEach(row => {
    const key = row.Date && row.Activity ? `${row.Date}|${row.Activity}` : null;
    if (!key) return;
    if (!byKey[key] || score(row) > score(byKey[key])) byKey[key] = row;
  });

  const rows = Object.values(byKey).sort((a, b) => new Date(a.Date) - new Date(b.Date));

  // Pagination
  const total = rows.length;
  const pages = Math.max(1, Math.ceil(total / tablePageSize));
  if (tablePage === -1) tablePage = pages; // sentinel: go to last page when coming from previous month
  if (tablePage > pages) tablePage = pages;
  if (tablePage < 1) tablePage = 1;

  const start = (tablePage - 1) * tablePageSize;
  const pageRows = rows.slice(start, start + tablePageSize);

  // Render rows
  pageRows.forEach(row => {
    let tr = document.createElement("tr");
    let rowClass = row.Activity === "Seminar" ? "seminar-row" :
                   row.Activity === "Journal Club" ? "journal-row" : "audit-row";
    tr.className = rowClass;
    tr.innerHTML = `
      <td>${row.Date || ""}</td>
      <td>${row.Activity || ""}</td>
      <td>${row.Topic || ""}</td>
      <td>${row.Resident || ""}</td>
      <td>${row.Status || ""}</td>
      <td>${row.FileLink ? `<a href="${row.FileLink}" target="_blank">View</a>` : ""}</td>
      <td>${row.Feedback || ""}</td>
      <td>${row.Comments || ""}</td>
      <td><button class="btn" onclick="openModal('${row.id}')"><i class="fa fa-pen"></i> Edit</button></td>
    `;
    tbody.appendChild(tr);
  });

  if (total === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="9" style="text-align:center;color:#667">No activities in ${monthName(nowForBadge)} ${tableYear}.</td>`;
    tbody.appendChild(tr);
  }

  renderPaginationBar(total, pages);
}

function renderPaginationBar(total, pages){
  const bar = document.getElementById("paginationBar");
  bar.innerHTML = "";

  const info = document.createElement("div");
  info.className = "info";
  info.textContent = total ? `Total: ${total} item(s)` : "Total: 0";
  bar.appendChild(info);

  // Rows-per-page selector
  const label = document.createElement("span");
  label.className = "subtle";
  label.textContent = "Rows per page:";
  bar.appendChild(label);

  const sel = document.createElement("select");
  [5,10,20,50].forEach(n => {
    const opt = document.createElement("option");
    opt.value = n; opt.textContent = n;
    if (n === tablePageSize) opt.selected = true;
    sel.appendChild(opt);
  });
  sel.onchange = () => { tablePageSize = parseInt(sel.value,10); tablePage = 1; renderActivityTable(); };
  bar.appendChild(sel);

  // Prev
  const prev = document.createElement("button");
  prev.textContent = "Prev";
  prev.onclick = () => {
    if (tablePage > 1) {
      tablePage = Math.max(1, tablePage - 1);
      renderActivityTable();
    } else {
      // go to previous month, last page
      shiftTableMonth(-1, true);
    }
  };
  bar.appendChild(prev);

  // Page buttons (cap to 7 visible)
  const maxBtns = 7;
  let start = Math.max(1, tablePage - Math.floor(maxBtns/2));
  let end = Math.min(pages, start + maxBtns - 1);
  start = Math.max(1, end - maxBtns + 1);

  for (let p = start; p <= end; p++) {
    const btn = document.createElement("button");
    btn.textContent = p;
    if (p === tablePage) btn.classList.add("active");
    btn.onclick = () => { tablePage = p; renderActivityTable(); };
    bar.appendChild(btn);
  }

  // Next
  const next = document.createElement("button");
  next.textContent = "Next";
  next.onclick = () => {
    if (tablePage < pages) {
      tablePage = Math.min(pages, tablePage + 1);
      renderActivityTable();
    } else {
      // go to next month, first page
      shiftTableMonth(1, false);
    }
  };
  bar.appendChild(next);
}

/* ---------- Calendar ---------- */
function renderCalendar() {
  if (calendar) { calendar.destroy(); }
  const calendarEl = document.getElementById('calendar');
  if (!filteredData || filteredData.length === 0) {
    calendarEl.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:40px;">No activities to show on calendar.</div>';
    return;
  }

  // Enforce weekday rules first
  const validRows = filteredData.filter(isValidAcademicRow);

  // DEDUPE for Calendar: keep only one row per Date+Activity (prefer Topic/Resident filled)
  const pickBest = (a, b) => {
    const score = r => (r.Topic ? 1 : 0) + (r.Resident ? 1 : 0);
    return (score(b) > score(a)) ? b : a;
  };
  const byKey = {};
  validRows.forEach(row => {
    const key = `${row.Date}|${row.Activity}`;
    byKey[key] = byKey[key] ? pickBest(byKey[key], row) : row;
  });

  const events = Object.values(byKey).map(row => {
    let className = row.Activity === "Seminar" ? "seminar"
                  : row.Activity === "Journal Club" ? "journal"
                  : "audit";
    return {
      title: `${row.Activity}: ${row.Topic || ""} (${row.Resident || ""})`,
      start: row.Date,
      className,
      extendedProps: { ...row }
    };
  });

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 500,
    events,
    eventClick: function(info) {
      openModal(info.event.extendedProps.id || "");
    }
  });
  calendar.render();
}

/* ---------- Modals & Actions ---------- */
function openModal(rowId) {
  let row = allData.find(r => String(r.id) === String(rowId));
  if (!row) row = { Date: "", Activity: "Seminar", Topic: "", Resident: RESIDENTS[0], Status: "Pending", FileLink: "", Feedback: "", Comments: "", id: "" };
  activeRowId = row.id;
  document.getElementById("editRowId").value = activeRowId;
  document.getElementById("editDate").value = row.Date || "";
  document.getElementById("editActivity").value = row.Activity || "Seminar";
  document.getElementById("editTopic").value = row.Topic || "";
  document.getElementById("editResident").value = row.Resident || RESIDENTS[0];
  document.getElementById("editStatus").value = row.Status || "Pending";
  document.getElementById("editFileLink").value = row.FileLink || "";
  document.getElementById("editFeedback").value = row.Feedback || "";
  document.getElementById("editComments").value = row.Comments || "";
  document.getElementById("modal").classList.remove("hidden");
}
function closeModal() {
  document.getElementById("modal").classList.add("hidden");
}
document.getElementById("editForm").onsubmit = async function(e) {
  e.preventDefault();
  let idx = allData.findIndex(r => String(r.id) === String(activeRowId));
  if (idx === -1) { alert("Row not found"); return; }
  const updated = {
    Date: document.getElementById("editDate").value,
    Activity: document.getElementById("editActivity").value,
    Topic: document.getElementById("editTopic").value,
    Resident: document.getElementById("editResident").value,
    Status: document.getElementById("editStatus").value,
    FileLink: document.getElementById("editFileLink").value,
    Feedback: document.getElementById("editFeedback").value,
    Comments: document.getElementById("editComments").value
  };
  try {
    await fetch(`${SHEETDB_API}/id/${activeRowId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: updated })
    });
    Object.assign(allData[idx], updated);
    renderUpcoming();
    renderActivityTable();
    renderCalendar();
    closeModal();
  } catch (err) {
    alert("Failed to update activity! " + err);
  }
};

/* ---------- Auto Allocate / Manual Allocate / Generate / Cleanup ---------- */
async function autoAllocate() {
  let seminarRows = allData.filter(row =>
    row.Activity === "Seminar" &&
    row.Date &&
    new Date(row.Date).getDay() === 3 &&
    new Date(row.Date).getDate() > 7
  ).sort((a, b) => new Date(a.Date) - new Date(b.Date));

  let jcRows = allData.filter(row =>
    row.Activity === "Journal Club" &&
    row.Date &&
    new Date(row.Date).getDay() === 4
  ).sort((a, b) => new Date(a.Date) - new Date(b.Date));

  let n = RESIDENTS.length;
  let seminarIndex = 0;
  let jcIndex = 0;
  let success = 0, fail = 0;

  for (let i = 0; i < seminarRows.length; i++) {
    let resident = RESIDENTS[seminarIndex % n];
    seminarIndex++;
    try {
      let response = await fetch(`${SHEETDB_API}/id/${seminarRows[i].id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: { Resident: resident } })
      });
      let result = await response.json();
      if (result.updated === 1) success++;
      else fail++;
    } catch (err) { fail++; }
    if ((seminarIndex) % n === 0) seminarIndex += n;
  }

  for (let i = 0; i < jcRows.length; i++) {
    let resident = RESIDENTS[jcIndex % n];
    jcIndex++;
    try {
      let response = await fetch(`${SHEETDB_API}/id/${jcRows[i].id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: { Resident: resident } })
      });
      let result = await response.json();
      if (result.updated === 1) success++;
      else fail++;
    } catch (err) { fail++; }
    if ((jcIndex) % n === 0) jcIndex += n;
  }

  await fetchActivities();
  alert(`Auto-allocation finished! Success: ${success}, Fail: ${fail}`);
}

function openManualAllocate() {
  let options = "";
  allData.forEach(row => {
    options += `<option value="${row.id}">${row.Date} - ${row.Activity} (${row.Topic || ""}) [${row.Resident || ""}]</option>`;
  });
  document.getElementById("manualActivity").innerHTML = options;
  let rid = allData[0] ? allData[0].id : "";
  let row = allData.find(r => String(r.id) === String(rid));
  document.getElementById("manualResident").value = row ? row.Resident : RESIDENTS[0];
  document.getElementById("manualTopic").value = row ? row.Topic : "";
  document.getElementById("manualModal").classList.remove("hidden");
  document.getElementById("manualActivity").onchange = function() {
    let r = allData.find(x => String(x.id) === String(this.value));
    document.getElementById("manualResident").value = r ? r.Resident : RESIDENTS[0];
    document.getElementById("manualTopic").value = r ? r.Topic : "";
  };
}
function closeManualModal() { document.getElementById("manualModal").classList.add("hidden"); }

async function generateActivities() {
  if (!confirm("This will add 4 months of Seminar (Wed), JC (Thu), and Audit (first Wed) from next week. Proceed?")) return;

  const today = new Date();
  const nextWed = new Date(today);
  nextWed.setDate(nextWed.getDate() + ((3 - today.getDay() + 7) % 7));
  const nextThu = new Date(today);
  nextThu.setDate(nextThu.getDate() + ((4 - today.getDay() + 7) % 7));

  const existing = new Set(
    (allData || [])
      .filter(r => r.Date && r.Activity)
      .map(r => `${r.Date}|${r.Activity}`)
  );

  const activities = [];
  let id = Date.now();

  for (let w = 0; w < 16; w++) {
    let d1 = new Date(nextWed); d1.setDate(nextWed.getDate() + w*7);
    let d2 = new Date(nextThu); d2.setDate(nextThu.getDate() + w*7);
    const sDate = d1.toISOString().slice(0,10);
    const jDate = d2.toISOString().slice(0,10);

    if (d1.getDay() === 3 && d1.getDate() > 7 && !existing.has(`${sDate}|Seminar`)) {
      activities.push({ id:(id++).toString(), Date:sDate, Activity:"Seminar", Topic:"", Resident:"", Status:"Pending", FileLink:"", Feedback:"", Comments:"" });
      existing.add(`${sDate}|Seminar`);
    }
    if (d2.getDay() === 4 && !existing.has(`${jDate}|Journal Club`)) {
      activities.push({ id:(id++).toString(), Date:jDate, Activity:"Journal Club", Topic:"", Resident:"", Status:"Pending", FileLink:"", Feedback:"", Comments:"" });
      existing.add(`${jDate}|Journal Club`);
    }
    if (d1.getDay() === 3 && d1.getDate() <= 7 && !existing.has(`${sDate}|Audit`)) {
      activities.push({ id:(id++).toString(), Date:sDate, Activity:"Audit", Topic:"Surgical Audit", Resident:"", Status:"Pending", FileLink:"", Feedback:"", Comments:"" });
      existing.add(`${sDate}|Audit`);
    }
  }

  try {
    for (const act of activities) {
      await fetch(SHEETDB_API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data: act }) });
    }
    await fetchActivities();
    alert(`Activities for 4 months generated! Added: ${activities.length}.`);
  } catch (err) {
    alert("Failed to generate activities. " + err);
  }
}

async function cleanupDuplicates() {
  if (!confirm("This will remove duplicate rows so only one entry per Date+Activity remains. Proceed?")) return;
  const groups = {};
  const score = r => (r.Topic ? 1 : 0) + (r.Resident ? 1 : 0);
  (allData || []).forEach(r => {
    if (!r.Date || !r.Activity) return;
    const key = `${r.Date}|${r.Activity}`;
    groups[key] = groups[key] || [];
    groups[key].push(r);
  });
  const toDelete = [];
  Object.values(groups).forEach(rows => {
    if (rows.length <= 1) return;
    rows.sort((a, b) => score(b) - score(a));
    rows.slice(1).forEach(r => toDelete.push(r.id));
  });
  try {
    for (const id of toDelete) {
      await fetch(`${SHEETDB_API}/id/${id}`, { method: "DELETE" });
    }
    await fetchActivities();
    alert(`Cleanup complete. Removed ${toDelete.length} duplicate rows.`);
  } catch (e) {
    alert("Failed to cleanup duplicates: " + e);
  }
}

/* ---------- Boot ---------- */
window.onload = function() {
  fetchActivities();
  document.getElementById("modal").addEventListener("click", function(e) { if (e.target === this) closeModal(); });
  document.getElementById("manualModal").addEventListener("click", function(e) { if (e.target === this) closeManualModal(); });
};
  </script>
</body>
</html>

